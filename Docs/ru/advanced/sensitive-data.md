# Маскирование чувствительных данных

Letopis предоставляет встроенную поддержку для маскирования конфиденциальной информации в полезных нагрузках логов, чтобы предотвратить случайное раскрытие паролей, токенов, API-ключей и других конфиденциальных данных.

> **Важно:** С ноября 2025 года маскирование чувствительных данных **включено по умолчанию** для всех глобально настроенных конфиденциальных ключей. Используйте `.notSensitive()` для явного отключения маскирования при необходимости.

## Стратегии маскирования

Доступны четыре стратегии маскирования через `SensitiveDataStrategy`:

### `.full`

Заменяет всё значение на `***`

```swift
"secret123" → "***"
```

### `.partial`

Оставляет первый и последний символы, маскирует остальное

```swift
"secret123" → "s***3"
```

### `.email`

Маскирует часть с именем пользователя в email

```swift
"user@example.com" → "u***@example.com"
```

### `.last4`

Показывает только последние 4 символа (полезно для номеров карт)

```swift
"1234567890123456" → "***3456"
```

## Глобальные конфиденциальные ключи

Настройте конфиденциальные ключи глобально при создании логгера:

```swift
let logger = Letopis(
    interceptors: [ConsoleInterceptor()],
    sensitiveKeys: ["password", "token", "api_key", "ssn"])

// Добавить больше ключей динамически
logger.addSensitiveKeys(["credit_card", "secret"])

// Удалить ключи при необходимости
logger.removeSensitiveKeys(["api_key"])
```

Глобальные ключи используют стратегию `.partial` по умолчанию.

## Поведение по умолчанию (с ноября 2025)

**Маскирование теперь включено по умолчанию.** Любые ключи из глобального списка `sensitiveKeys` автоматически маскируются:

```swift
let logger = Letopis(
    interceptors: [ConsoleInterceptor()],
    sensitiveKeys: ["password", "token"]
)

// Маскирование происходит автоматически - не требуется вызов .sensitive()
logger.log()
    .payload(["password": "secret123", "username": "john"])
    .info("Пользователь вошел в систему")

// Вывод: password=s***3, username=john ✅ password маскируется по умолчанию
```

### Отключение маскирования

Используйте `.notSensitive()` для явного отключения маскирования в конкретных логах:

```swift
logger.log()
    .payload(["password": "secret123", "token": "abc123"])
    .notSensitive()  // Отключить маскирование только для этого лога
    .info("Отладка процесса аутентификации")

// Вывод: password=secret123, token=abc123 (показано в открытом виде)
```

> **Предупреждение:** Используйте `.notSensitive()` только в сценариях разработки/отладки. Production логи должны оставлять маскирование включенным по умолчанию.

## Маскирование для отдельных логов

### Маскирование конкретных ключей с пользовательскими стратегиями

```swift
logger.log()
    .payload(["email": "user@example.com", "card": "1234567890123456"])
    .sensitive(key: "email", strategy: .email)
    .sensitive(key: "card", strategy: .last4)
    .info("Платеж обработан")

// Вывод: email=u***@example.com, card=***3456
```

### Маскирование нескольких ключей с одной стратегией

```swift
logger.log()
    .payload(["token": "abc123", "refresh_token": "xyz789"])
    .sensitive(keys: ["token", "refresh_token"], strategy: .full)
    .info("Аутентификация завершена")

// Вывод: token=***, refresh_token=***
```

## Важные замечания

- **Маскирование включено по умолчанию** для всех ключей из глобального списка `sensitiveKeys` (с ноября 2025)
- Используйте `.notSensitive()` для явного отключения маскирования в конкретных событиях логирования
- Пользовательские стратегии ключей (через `.sensitive(keys:strategy:)`) имеют приоритет над глобальными конфиденциальными ключами
- Маскирование происходит до того, как событие достигнет перехватчиков
- Метаданные источника (`source_file`, `source_function` и т.д.) никогда не маскируются

## Лучшие практики

1. **Определяйте конфиденциальные ключи заранее**: Настраивайте глобальные ключи при инициализации логгера
2. **Используйте подходящие стратегии**: Выбирайте стратегии маскирования, которые балансируют безопасность и отладку
3. **Регулярно проверяйте логи**: Убедитесь, что конфиденциальные данные не утекают
4. **Документируйте конфиденциальные поля**: Ведите список полей, которые всегда должны маскироваться
5. **Тестируйте логику маскирования**: Проверяйте, что конфиденциальные данные правильно маскируются во всех сценариях

## Распространенные конфиденциальные поля

```swift
let logger = Letopis(
    interceptors: [...],
    sensitiveKeys: [
        // Аутентификация
        "password", "token", "refresh_token", "api_key", "secret",
        
        // Персональная информация
        "ssn", "passport", "driver_license",
        
        // Финансовые данные
        "credit_card", "cvv", "account_number",
        
        // Здоровье
        "medical_record", "diagnosis"
    ])
```

---

[Назад к индексу документации](../index.md)
